"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),midinotes={C:[0,12,24,36,48,60,72,84,96,108,120],D:[2,14,26,38,50,62,74,86,98,110,122],E:[4,16,28,40,52,64,76,88,100,112,124],F:[5,17,29,41,53,65,77,89,101,113,125],G:[7,19,31,43,55,67,79,91,103,115,127],A:[9,21,33,45,57,69,81,93,105,117],B:[11,23,35,47,59,71,83,95,107,119],"C#":[1,13,25,37,49,61,73,85,97,109,121],"D#":[3,15,27,39,51,63,75,87,99,111,123],"E#":[5,17,29,41,53,65,77,89,101,113,125],"F#":[6,18,30,42,54,66,78,90,102,114,126],"G#":[8,20,32,44,56,68,80,92,104,116],"A#":[10,22,34,46,58,70,82,94,106,118],"B#":[0,12,24,36,48,60,72,84,96,108,120],Db:[1,13,25,37,49,61,73,85,97,109,121],Eb:[3,15,27,39,51,63,75,87,99,111,123],Fb:[4,16,28,40,52,64,76,88,100,112,124],Gb:[6,18,30,42,54,66,78,90,102,114,126],Ab:[8,20,32,44,56,68,80,92,104,116],Bb:[10,22,34,46,58,70,82,94,106,118],Cb:[11,23,35,47,59,71,83,95,107,119]},noteon=144,noteoff=128,aftertouch=160,controlchange=176,programchange=192,channelpressure=208,pitchbend=224,MIDIData=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"MidiNotes",get:function(){return midinotes}},{key:"NoteOff",get:function(){return noteoff}},{key:"NoteOn",get:function(){return noteon}},{key:"AfterTouch",get:function(){return aftertouch}},{key:"ControlChange",get:function(){return controlchange}},{key:"ProgramChange",get:function(){return programchange}},{key:"ChannelPressure",get:function(){return channelpressure}},{key:"PitchBend",get:function(){return pitchbend}}]),e}(),accidentals={C:"#",G:"#",D:"#",A:"#",E:"#",B:"#",Cb:"b","F#":"#",Gb:"b","C#":"#",Db:"b",Ab:"b",Eb:"b",Bb:"b",F:"b"},keynotes$1={C:["C","D","E","F","G","A","B"],G:["G","A","B","C","D","E","F#"],D:["D","E","F#","G","A","B","C#"],A:["A","B","C#","D","E","F#","G#"],E:["E","F#","G#","A","B","C#","D#"],B:["B","C#","D#","E","F#","G#","A#"],"F#":["F#","G#","A#","B","C#","D#","E#"],"C#":["C#","D#","E#","F#","G#","A#","B#"],Cb:["Cb","Db","Eb","Fb","Gb","Ab","Bb"],Gb:["Gb","Ab","Bb","Cb","Db","Eb","F"],Db:["Db","Eb","F","Gb","Ab","Bb","C"],Ab:["Ab","Bb","C","Db","Eb","F","G"],Eb:["Eb","F","G","Ab","Bb","C","D"],Bb:["Bb","C","D","Eb","F","G","A"],F:["F","G","A","Bb","C","D","E"]},keys=["C","G","D","A","E","B","Cb","F#","Gb","C#","Db","Ab","Eb","Bb","F"],Notation=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"Keys",get:function(){return keys}},{key:"KeyNotes",get:function(){return keynotes$1}},{key:"Accidentals",get:function(){return accidentals}}]),e}(),Generate=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"NoteOn",value:function(e,t){new Uint8Array([MIDIData.NoteOn,e,t])}},{key:"NoteOff",value:function(e,t){new Uint8Array([MIDIData.NoteOff,e,t])}},{key:"AfterTouch",value:function(e,t){new Uint8Array([MIDIData.AfterTouch,e,t])}},{key:"ControlChange",value:function(e,t){new Uint8Array([MIDIData.ControlChange,e,t])}},{key:"ProgramChange",value:function(e){new Uint8Array([MIDIData.ProgramChange,e])}},{key:"ChannelPressure",value:function(e){new Uint8Array([MIDIData.ChannelPressure,e])}},{key:"PitchBend",value:function(e){var t=1,n=1;new Uint8Array([MIDIData.ChannelPressure,t,n])}}]),e}(),notes=MIDIData.MidiNotes,NoteProcessor=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"processNoteEvent",value:function(e,t){var n=this.getNoteNames(e.data[1]),s={enharmonics:n,note:this.findNoteInKey(n,this.key),inKey:this.isNoteInKey(n,this.key),value:e.data[1],velocity:e.data[2],frequency:440*Math.pow(2,(e.data[1]-69)/12)};switch(t){case"NoteOn":this.keysPressed[e.data[1]]=s;break;case"NoteOff":delete this.keysPressed[e.data[1]]}return Object.assign(e,s)}},{key:"processCCEvent",value:function(e,t){Object.assign(e,{cc:t||e.data[1],value:e.data[2],ratio:e.data[2]/127,timestamp:e.receivedTime})}},{key:"processMidiControlEvent",value:function(e,t){Object.assign(e,{cc:t,value:e.data[1],ratio:e.data[1]/127,timestamp:e.receivedTime})}},{key:"processPitchWheel",value:function(e){var t=e.data[1]|e.data[2]<<7,n=-(8192-t),s=n/8192;return Object.assign(e,{cc:"pitchwheel",value:t,polar:n,polarRatio:s,timestamp:e.receivedTime})}},{key:"getNoteNames",value:function(e){var t=[];for(var n in notes)notes[n].forEach(function(s){e===s&&t.push(n)});return t}},{key:"findNoteInKey",value:function(e,t){for(var n=0;n<e.length;n++){var s=e[n];if(this.matchNoteInKey(s,t))return s}return e[0]}},{key:"isNoteInKey",value:function(e,t){for(var n=0;n<e.length;n++){var s=e[n];if(this.matchNoteInKey(s,t))return!0}return!1}},{key:"matchNoteInKey",value:function(e,t){for(var n=0;n<keynotes[t].length;n++){var s=keynotes[t][n];if(e===s)return!0}return!1}}]),e}(),listeners={},Events=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"on",value:function(e,t){return void 0===listeners[e]?listeners[e]=[t]:listeners[e].push(t),t}},{key:"off",value:function(e,t){if(listeners[e])for(var n=listeners[e].length-1;n>=0;n--){if(1!==listeners[e].length){listeners[e].splice(n,1);break}delete listeners[e]}}},{key:"onMIDIMessage",value:function(t){var n=null,s=null;switch(t.data[0]){case 128:n="NoteOff",delete this.keysPressed[t.data[1]],s=NoteProcessor.processNoteEvent(t,n);break;case 144:n=t.data[2]>0?"NoteOn":"NoteOff",s=NoteProcessor.processNoteEvent(t,n);break;case 176:n="Controller",s=NoteProcessor.processCCEvent(t);break;case 224:n="PitchWheel",s=NoteProcessor.processPitchWheel(t);break;case 208:n="Aftertouch",s=NoteProcessor.processMidiControlEvent(t,n);break;case 192:n="ProgramChange",s=NoteProcessor.processMidiControlEvent(t,n)}null!==n&&e.executeEventHandlers(n,s)}},{key:"executeEventHandlers",value:function(e,t){if(listeners[e])for(var n=listeners[e].length-1;n>=0;n--)if(void 0!==listeners[e]){if("function"!=typeof listeners[e][n]||!listeners[e][n])throw"Event handler is not a function.";listeners[e][n](t)}}},{key:"onCC",value:function(e,t){var n=function(n){n.cc==e&&t(n)};this.on("Controller",n)}},{key:"keyToggle",value:function(e,t){this.on("NoteOn",e),this.on("NoteOff",t)}},{key:"onNoteNumber",value:function(e,t){var n=function(n){n.value==e&&t(n)};this.on("NoteOn",n)}},{key:"offNoteNumber",value:function(e,t){var n=function(n){n.value==e&&t(n)};this.on("NoteOff",n)}},{key:"keyToggleRange",value:function(e,t,n,s){this.onRange(e,t,n),this.offRange(e,t,s)}},{key:"onRange",value:function(e,t,n,s){if(t>e)for(var a=e;a<=t;a++)this.onNoteNumber(a,n);else for(var o=t;o>=e;o--)this.onNoteNumber(o,n)}},{key:"offRange",value:function(e,t,n,s){if(t>e)for(var a=e;a<=t;a++)this.offNoteNumber(a,s);else for(var o=t;o>=e;o--)this.offNoteNumber(o,s)}},{key:"unbindAll",value:function(){this.unBindKeyboard();for(var e in listeners)delete listeners[e];return!0}},{key:"bindKeyboard",value:function(){window.addEventListener("keydown",this.keyboardKeyDown),window.addEventListener("keyup",this.keyboardKeyUp)}},{key:"unBindKeyboard",value:function(){window.removeEventListener("keydown",this.keyboardKeyDown),window.removeEventListener("keyup",this.keyboardKeyUp)}},{key:"keyboardKeyDown",value:function(t){var n=null;switch(t.keyCode){case 90:n=this.createMessage("NoteOn",60);break;case 83:n=this.createMessage("NoteOn",61);break;case 88:n=this.createMessage("NoteOn",62);break;case 68:n=this.createMessage("NoteOn",63);break;case 67:n=this.createMessage("NoteOn",64);break;case 86:n=this.createMessage("NoteOn",65);break;case 71:n=this.createMessage("NoteOn",66);break;case 66:n=this.createMessage("NoteOn",67);break;case 72:n=this.createMessage("NoteOn",68);break;case 78:n=this.createMessage("NoteOn",69);break;case 74:n=this.createMessage("NoteOn",70);break;case 77:n=this.createMessage("NoteOn",71);break;case 188:n=this.createMessage("NoteOn",72)}null!==n&&e.sendMidiMessage(n)}},{key:"keyboardKeyUp",value:function(e){var t=null;switch(e.keyCode){case 90:t=this.createMessage("NoteOff",60);break;case 83:t=this.createMessage("NoteOff",61);break;case 88:t=this.createMessage("NoteOff",62);break;case 68:t=this.createMessage("NoteOff",63);break;case 67:t=this.createMessage("NoteOff",64);break;case 86:t=this.createMessage("NoteOff",65);break;case 71:t=this.createMessage("NoteOff",66);break;case 66:t=this.createMessage("NoteOff",67);break;case 72:t=this.createMessage("NoteOff",68);break;case 78:t=this.createMessage("NoteOff",69);break;case 74:t=this.createMessage("NoteOff",70);break;case 77:t=this.createMessage("NoteOff",71);break;case 188:t=this.createMessage("NoteOff",72)}null!==t&&this.sendMidiMessage(t)}}]),e}(),key="C",midiAccess=null,Mizzy=function(){function e(){classCallCheck(this,e),window.MIDIMessageEvent||(window.MIDIMessageEvent=function(e,t){return this.name=e,Object.assign(this,t)}),this.key=key,this.setKey=function(e){key=e,this.key=key,console.log("SET KEY",key)},this.keysPressed=[],this.midiAccess=null,this.onMIDISuccess=function(e){midiAccess=e;for(var t=midiAccess.inputs.values(),n=t.next();n&&!n.done;n=t.next())n.value.onmidimessage=this.onMIDIMessage.bind(this)},this.onMIDIFailure=function(e){throw"No MIDI Available"},this.loopback=!0}return createClass(e,[{key:"loopBackMidiMessage",value:function(e){this.onMIDIMessage(e)}}],[{key:"initialize",value:function(){console.log(midiAccess),null===midiAccess&&(navigator.requestMIDIAccess?navigator.requestMIDIAccess({sysex:!1}).then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this)):alert("No MIDI support in your browser."))}},{key:"sendMidiMessage",value:function(e){if(null!==midiAccess)for(var t=midiAccess.outputs.values(),n=t.next();n&&!n.done;n=t.next())n.value.send(e.data,e.timeStamp);this.loopback&&this.loopBackMidiMessage(e)}},{key:"createMessage",value:function(e,t){var n=null;switch(e){case"NoteOn":n=Generate.NoteOn(t,127);break;case"NoteOff":n=Generate.NoteOff(t,127)}var s=new MIDIMessageEvent("midimessage",{data:n})||{data:n};return this.processNoteEvent(s,e)}}]),e}();exports.MIDIData=MIDIData,exports.Notation=Notation,exports.Generate=Generate,exports.NoteProcessor=NoteProcessor,exports.Event=Events,exports.Mizzy=Mizzy;