"use strict";var classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},Events=function(){function e(){classCallCheck(this,e),this.listeners={}}return createClass(e,[{key:"on",value:function(e,t){return void 0===this.listeners[e]?this.listeners[e]=[t]:this.listeners[e].push(t),t}},{key:"off",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.listeners[e])if(null==t)for(var n=this.listeners[e].length-1;n>=0;n--)return 1===this.listeners[e].length?(delete this.listeners[e],!0):(this.listeners[e].splice(n,1),!0);else for(var i=0;i<this.listeners[e].length;i++)if(this.listeners[e][i]==t)return this.listeners[e].splice(i,1),0===this.listeners[e].length&&delete this.listeners[e],!0;return!1}},{key:"trigger",value:function(e,t){if(this.listeners[e])for(var n=this.listeners[e].length-1;n>=0;n--)if(void 0!==this.listeners[e]){if("function"!=typeof this.listeners[e][n]||!this.listeners[e][n])throw"Event handler is not a function.";this.listeners[e][n](t)}}}]),e}(),GLOBAL_TUNE=440,MIDI_14BIT_MAX_VALUE=16384,MIDI_MAX_VALUE=127,Convert=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"MIDINoteToFrequency",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:GLOBAL_TUNE;return t*Math.pow(2,(e-69)/12)}},{key:"PitchWheelToPolar",value:function(e){return-(.5*MIDI_14BIT_MAX_VALUE-e)}},{key:"PitchWheelToPolarRatio",value:function(t){return e.PitchWheelToPolar(t)/(.5*MIDI_14BIT_MAX_VALUE)}},{key:"MidiValueToRatio",value:function(e){return e/MIDI_MAX_VALUE}},{key:"MidiValueToPolarRatio",value:function(e){var t=.5*MIDI_MAX_VALUE;return-(t-e)/t}},{key:"MidiChannel",value:function(e){return(15&e)+1}}]),e}(),MIDI_NOTE_ON=144,MIDI_NOTE_OFF=128,MIDI_AFTERTOUCH=160,MIDI_CONTROL_CHANGE=176,MIDI_PROGRAM_CHANGE=192,MIDI_CHANNEL_PRESSURE=208,MIDI_PITCHBEND=224,MIDI_MESSAGE_EVENT="midimessage",NOTE_ON_EVENT="NoteOn",NOTE_OFF_EVENT="NoteOff",PITCHWHEEL_EVENT="PitchWheel",CONTROLLER_EVENT="Controller",PROGRAM_CHANGE_EVENT$1="ProgramChange",AFTERTOUCH_EVENT$1="Aftertouch",KEYBOARD_EVENT_KEY_DOWN="keydown",KEYBOARD_EVENT_KEY_UP="keyup",ENHARMONIC_KEYS=["C","G","D","A","E","B","Cb","F#","Gb","C#","Db","Ab","Eb","Bb","F"],MIDI_NOTE_MAP={C:[0,12,24,36,48,60,72,84,96,108,120],D:[2,14,26,38,50,62,74,86,98,110,122],E:[4,16,28,40,52,64,76,88,100,112,124],F:[5,17,29,41,53,65,77,89,101,113,125],G:[7,19,31,43,55,67,79,91,103,115,127],A:[9,21,33,45,57,69,81,93,105,117],B:[11,23,35,47,59,71,83,95,107,119],"C#":[1,13,25,37,49,61,73,85,97,109,121],"D#":[3,15,27,39,51,63,75,87,99,111,123],"E#":[5,17,29,41,53,65,77,89,101,113,125],"F#":[6,18,30,42,54,66,78,90,102,114,126],"G#":[8,20,32,44,56,68,80,92,104,116],"A#":[10,22,34,46,58,70,82,94,106,118],"B#":[0,12,24,36,48,60,72,84,96,108,120],Db:[1,13,25,37,49,61,73,85,97,109,121],Eb:[3,15,27,39,51,63,75,87,99,111,123],Fb:[4,16,28,40,52,64,76,88,100,112,124],Gb:[6,18,30,42,54,66,78,90,102,114,126],Ab:[8,20,32,44,56,68,80,92,104,116],Bb:[10,22,34,46,58,70,82,94,106,118],Cb:[11,23,35,47,59,71,83,95,107,119]},KEY_NOTE_ARRAYS={C:["C","D","E","F","G","A","B"],G:["G","A","B","C","D","E","F#"],D:["D","E","F#","G","A","B","C#"],A:["A","B","C#","D","E","F#","G#"],E:["E","F#","G#","A","B","C#","D#"],B:["B","C#","D#","E","F#","G#","A#"],"F#":["F#","G#","A#","B","C#","D#","E#"],"C#":["C#","D#","E#","F#","G#","A#","B#"],Cb:["Cb","Db","Eb","Fb","Gb","Ab","Bb"],Gb:["Gb","Ab","Bb","Cb","Db","Eb","F"],Db:["Db","Eb","F","Gb","Ab","Bb","C"],Ab:["Ab","Bb","C","Db","Eb","F","G"],Eb:["Eb","F","G","Ab","Bb","C","D"],Bb:["Bb","C","D","Eb","F","G","A"],F:["F","G","A","Bb","C","D","E"]},DataProcess=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"NoteEvent",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ENHARMONIC_KEYS[0],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=t.data[1]+i,o=this.getNoteNames(r),s={enharmonics:o,note:e.findNoteInKey(o,n),inKey:e.isNoteInKey(o,n),value:r,velocity:t.data[2],frequency:Convert.MIDINoteToFrequency(r),channel:Convert.MidiChannel(t.data[0])};return Object.assign(t,s)}},{key:"CCEvent",value:function(e,t){return Object.assign(e,{cc:t||e.data[1],value:e.data[2],ratio:Convert.MidiValueToRatio(e.data[2]),polarRatio:Convert.MidiValueToPolarRatio(e.data[2]),channel:Convert.MidiChannel(e.data[0])})}},{key:"MidiControlEvent",value:function(e,t){return Object.assign(e,{cc:t,value:e.data[1],ratio:Convert.MidiValueToRatio(e.data[2]),channel:Convert.MidiChannel(e.data[0])})}},{key:"PitchWheelEvent",value:function(e){var t=e.data[1]|e.data[2]<<7;return Object.assign(e,{cc:"pitchwheel",value:t,polar:Convert.PitchWheelToPolar(t),polarRatio:Convert.PitchWheelToPolarRatio(t),channel:Convert.MidiChannel(e.data[0])})}},{key:"getNoteNames",value:function(e){var t=[];for(var n in MIDI_NOTE_MAP)MIDI_NOTE_MAP[n].forEach(function(i){e===i&&t.push(n)});return t}},{key:"findNoteInKey",value:function(t,n){for(var i=0;i<t.length;i++){var r=t[i];if(e.matchNoteInKey(r,n))return r}return t[0]}},{key:"isNoteInKey",value:function(e,t){for(var n=0;n<e.length;n++){var i=e[n];if(this.matchNoteInKey(i,t))return!0}return!1}},{key:"matchNoteInKey",value:function(e,t){for(var n=0;n<KEY_NOTE_ARRAYS[t].length;n++){var i=KEY_NOTE_ARRAYS[t][n];if(e===i)return!0}return!1}}]),e}(),Generate=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"NoteOn",value:function(e,t){return new Uint8Array([MIDI_NOTE_ON,e,t])}},{key:"NoteOff",value:function(e,t){return new Uint8Array([MIDI_NOTE_OFF,e,t])}},{key:"AfterTouch",value:function(e,t){return new Uint8Array([MIDI_AFTERTOUCH,e,t])}},{key:"CC",value:function(e,t){return new Uint8Array([MIDI_CONTROL_CHANGE,e,t])}},{key:"ProgramChange",value:function(e){return new Uint8Array([MIDI_PROGRAM_CHANGE,e])}},{key:"ChannelPressure",value:function(e){return new Uint8Array([MIDI_CHANNEL_PRESSURE,e])}},{key:"PitchBend",value:function(e){var t=0,n=0;return new Uint8Array([MIDI_PITCHBEND,t,n])}},{key:"MidiEvent",value:function(e,t){var n=window,i=n.MIDIMessageEvent,r=new i(MIDI_MESSAGE_EVENT,{data:e})||{data:e};switch(240&e[0]){case MIDI_NOTE_ON:return DataProcess.NoteEvent(r,t);case MIDI_NOTE_OFF:return DataProcess.NoteEvent(r,t);case MIDI_CONTROL_CHANGE:return DataProcess.CCEvent(r);case MIDI_PITCHBEND:return DataProcess.PitchWheelEvent(r);case MIDI_AFTERTOUCH:return DataProcess.MidiControlEvent(r,AFTERTOUCH_EVENT);case MIDI_PROGRAM_CHANGE:return DataProcess.MidiControlEvent(r,PROGRAM_CHANGE_EVENT)}}},{key:"NoteEvent",value:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:127,r=window,o=r.MIDIMessageEvent,s=null;switch(t){case NOTE_ON_EVENT:s=e.NoteOn(n,i);break;case NOTE_OFF_EVENT:s=e.NoteOff(n,i)}var a=new o(MIDI_MESSAGE_EVENT,{data:s})||{data:s};return DataProcess.NoteEvent(a,this.key)}},{key:"CCEvent",value:function(t,n){var i=window,r=i.MIDIMessageEvent,o=e.CC(t,n),s=new r(MIDI_MESSAGE_EVENT,{data:o});return DataProcess.CCEvent(s)}},{key:"PitchBendEvent",value:function(t){var n=window,i=n.MIDIMessageEvent,r=e.PitchBend(t),o=new i(MIDI_MESSAGE_EVENT,{data:r});return DataProcess.CCEvent(o)}}]),e}(),KEY_CODE_MAP={90:60,83:61,88:62,68:63,67:64,86:65,71:66,66:67,72:68,78:69,74:70,77:71,188:72},MIDIEvents=function(e){function t(){classCallCheck(this,t);var e=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.keysPressed=[],e.keyboardKeyPressed=[],e}return inherits(t,e),createClass(t,[{key:"onMIDIMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ENHARMONIC_KEYS[0],n=null,i=null;switch(240&e.data[0]){case MIDI_NOTE_OFF:n=NOTE_OFF_EVENT,delete this.keysPressed[e.data[1]],i=DataProcess.NoteEvent(e,t);break;case MIDI_NOTE_ON:n=e.data[2]>0?NOTE_ON_EVENT:NOTE_OFF_EVENT,i=DataProcess.NoteEvent(e,t),n==NOTE_ON_EVENT?this.keysPressed[e.data[1]]=i:delete this.keysPressed[e.data[1]];break;case MIDI_CONTROL_CHANGE:n=CONTROLLER_EVENT,i=DataProcess.CCEvent(e);break;case MIDI_PITCHBEND:n=PITCHWHEEL_EVENT,i=DataProcess.PitchWheelEvent(e);break;case MIDI_AFTERTOUCH:n=AFTERTOUCH_EVENT$1,i=DataProcess.MidiControlEvent(e,n);break;case MIDI_PROGRAM_CHANGE:n=PROGRAM_CHANGE_EVENT$1,i=DataProcess.MidiControlEvent(e,n)}null!==n&&this.trigger(n,i)}},{key:"onCC",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return null==n?this.on(CONTROLLER_EVENT,function(n){n.cc==e&&t(n)}):this.on(CONTROLLER_EVENT,function(i){i.cc==e&&i.channel==n&&t(i)})}},{key:"removeCC",value:function(e){return this.off(CONTROLLER_EVENT,e)}},{key:"keyToggle",value:function(e,t){return{keyDown:this.on(NOTE_ON_EVENT,e),keyUp:this.on(NOTE_OFF_EVENT,t)}}},{key:"removeKeyToggle",value:function(e){this.off(NOTE_ON_EVENT,e.keyDown),this.off(NOTE_OFF_EVENT,e.keyUp)}},{key:"pressNoteNumber",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return null==n?this.on(NOTE_ON_EVENT,function(n){n.value==e&&t(n)}):this.on(NOTE_ON_EVENT,function(i){i.value==e&&i.channel==n&&t(i)})}},{key:"removePressNoteNumber",value:function(e){return this.off(NOTE_ON_EVENT,e)}},{key:"releaseNoteNumber",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return null==n?this.on(NOTE_OFF_EVENT,function(n){n.value==e&&t(n)}):this.on(NOTE_OFF_EVENT,function(i){i.value==e&&i.channel==n&&t(i)})}},{key:"removeReleaseNoteNumber",value:function(e){return this.off(NOTE_OFF_EVENT,e)}},{key:"keyToggleRange",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return{press:this.onSplit(e,t,n,r),release:this.offSplit(e,t,i,r)}}},{key:"onSplit",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=[];if(t>e)for(var o=e;o<=t;o++)r.push(this.pressNoteNumber(o,n,i));else for(var s=t;s>=e;s--)r.push(this.pressNoteNumber(s,n,i));return r}},{key:"offSplit",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=[];if(t>e)for(var o=e;o<=t;o++)r.push(this.releaseNoteNumber(o,n,i));else for(var s=t;s>=e;s--)r.push(this.releaseNoteNumber(s,n,i));return r}},{key:"removeKeyToggleRange",value:function(e){var t=this,n=e.press.forEach(function(e){return t.removePressNoteNumber(e)}),i=e.release.forEach(function(e){return t.removeReleaseNoteNumber(e)});return 1==i&&1==n}},{key:"unbindAll",value:function(){this.unBindKeyboard();for(var e in this.listeners)delete this.listeners[e];return!0}},{key:"bindKeyboard",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;window.addEventListener(KEYBOARD_EVENT_KEY_DOWN,function(n){return e.keyboardKeyDown(n,t)}),window.addEventListener(KEYBOARD_EVENT_KEY_UP,function(n){return e.keyboardKeyUp(n,t)})}},{key:"unBindKeyboard",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;window.removeEventListener(KEYBOARD_EVENT_KEY_DOWN,function(n){return e.keyboardKeyDown(n,t)}),window.removeEventListener(KEYBOARD_EVENT_KEY_UP,function(n){return e.keyboardKeyUp(n,t)})}},{key:"keyboardKeyDown",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(void 0!=KEY_CODE_MAP[e.keyCode]&&1!=this.keyboardKeyPressed[e.keyCode]){this.keyboardKeyPressed[e.keyCode]=!0;var n=Generate.NoteEvent(NOTE_ON_EVENT,KEY_CODE_MAP[e.keyCode]);null!==n&&this.sendMidiMessage(n,t)}}},{key:"keyboardKeyUp",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(void 0!=KEY_CODE_MAP[e.keyCode]&&1==this.keyboardKeyPressed[e.keyCode]){delete this.keyboardKeyPressed[e.keyCode];var n=Generate.NoteEvent(NOTE_OFF_EVENT,KEY_CODE_MAP[e.keyCode]);null!==n&&this.sendMidiMessage(n,t)}}},{key:"sendMidiMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;null!=t&&(e.data[0]=e.data[0]|parseInt(t-1,16)),this.boundOutputs.forEach(function(t){t.send(e.data,e.timeStamp)}),this.loopback&&this.onMIDIMessage(e,this.key)}}]),t}(Events),TICK_INCREMENT=.25,DEFAULT_LOOP_LENGTH=16,DEFAULT_TEMPO=120,TICK_LENGTH=.2,Clock=function(e){function t(e){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.context=e||new AudioContext,n.BPM=DEFAULT_TEMPO,n.tickSchedule,n.tick=0,n.playing=!1,n.loopIndex=0,n.startClock=0,n.index=0,n.looplength=DEFAULT_LOOP_LENGTH,n.direction=1,n.lastTick=0,n}return inherits(t,e),createClass(t,[{key:"reset",value:function(){this.index=0,this.loopIndex=0}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.tick=0,this.startClock=this.context.currentTime+.005,this.index=e,this.loopIndex=t,this.playing=!0,this.trigger("play",this.context.currentTime+.005),this.schedule()}},{key:"stop",value:function(){this.trigger("stop"),this.playing=!1}},{key:"schedule",value:function(){var e=this;if(this.playing){for(var t=this.context.currentTime-this.startClock;this.tick<t+TICK_LENGTH;){this.tick+this.startClock;this.process(this.index,this.loopIndex,this.tick,t),this.next()}this.tickSchedule=setTimeout(function(){return e.schedule()},0)}}},{key:"process",value:function(e,t,n,i){var r={index:e,loopIndex:t,globalTime:i};this.trigger("tick",r)}},{key:"next",value:function(){var e=60/this.BPM;this.index++,this.loopIndex+=this.direction,this.loopIndex>this.looplength-1?this.loopIndex=0:this.loopIndex<0&&(this.loopIndex=this.looplength-1),this.tick+=TICK_INCREMENT*e}}]),t}(Events),MidiMessage=function(e){function t(e,n){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n));return i.name=e,i}return inherits(t,e),t}(MessageEvent);void 0===window.MIDIMessageEvent&&(window.MIDIMessageEvent=MidiMessage);var Mizzy=function(e){function t(){classCallCheck(this,t);var e=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.keysPressed=[],e.midiAccess=null,e.loopback=!0,e.boundInputs=[],e.boundOutputs=[],e.clock=new Clock,e.key=ENHARMONIC_KEYS[0],e}return inherits(t,e),createClass(t,null,[{key:"Generate",get:function(){return Generate}},{key:"Clock",get:function(){return Clock}},{key:"NOTE_ON",get:function(){return NOTE_ON_EVENT}},{key:"NOTE_OFF",get:function(){return NOTE_OFF_EVENT}},{key:"CONTROLCHANGE",get:function(){return CONTROLLER_EVENT}},{key:"PITCHWHEEL",get:function(){return PITCHWHEEL_EVENT}}]),createClass(t,[{key:"initialize",value:function(){var e=this;if(null===this.midiAccess)return navigator.requestMIDIAccess?navigator.requestMIDIAccess({sysex:!1}).then(function(t){return e.onMIDISuccess(t)},function(t){return e.onMIDIFailure(t)}):(console.warn("[Mizzy] Your browser does not support Web MIDI API. You can still use the local loopback however."),new Promise(function(e,t){setTimeout(function(){e()},50)}))}},{key:"setKey",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"C";this.key=ENHARMONIC_KEYS[ENHARMONIC_KEYS.indexOf(e.toUpperCase())]||"C"}},{key:"getMidiInputs",value:function(){if(null!=this.midiAccess)return this.midiAccess.inputs.values()}},{key:"getMidiOutputs",value:function(){if(null!=this.midiAccess)return this.midiAccess.outputs.values()}},{key:"bindToInput",value:function(e){var t=this;this.boundInputs.push(e),e.onmidimessage=function(e){return t.onMIDIMessage(e,t.key)}}},{key:"unbindInput",value:function(e){var t=this.boundInputs.indexOf(e);this.boundInputs.slice(1,t),e.onmidimessage=null}},{key:"bindToAllInputs",value:function(){if(null!=this.midiAccess)for(var e=this.getMidiInputs(),t=e.next();t&&!t.done;t=e.next())this.bindToInput(t.value)}},{key:"unbindAllInputs",value:function(){this.boundInputs.forEach(this.unbindInput)}},{key:"bindToOutput",value:function(e){this.boundOutputs.push(e)}},{key:"bindToAllOutputs",value:function(){if(null!=this.midiAccess)for(var e=this.getMidiOutputs(),t=e.next();t&&!t.done;t=e.next())this.bindToOutput(t.value)}},{key:"onMIDIFailure",value:function(e){throw e}},{key:"onMIDISuccess",value:function(e){this.midiAccess=e}},{key:"panic",value:function(){for(var e=0;e<127;e++)this.sendMidiMessage(Generate.MidiEvent(t.Generate.NoteOff(e,127),this.key))}},{key:"keys",get:function(){return ENHARMONIC_KEYS}},{key:"outputDevices",get:function(){for(var e=[],t=this.getMidiOutputs(),n=t.next();n&&!n.done;n=t.next())e.push(n.value);return e}},{key:"inputDevices",get:function(){for(var e=[],t=this.getMidiInputs(),n=t.next();n&&!n.done;n=t.next())e.push(n.value);return e}}]),t}(MIDIEvents);module.exports=Mizzy;