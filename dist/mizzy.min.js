var Mizzy=function(){"use strict";var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),n=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},i=function(){function n(){e(this,n),this.listeners={}}return t(n,[{key:"on",value:function(e,t){return void 0===this.listeners[e]?this.listeners[e]=[t]:this.listeners[e].push(t),t}},{key:"off",value:function(e){if(this.listeners[e])for(var t=this.listeners[e].length-1;t>=0;t--){if(1!==this.listeners[e].length){this.listeners[e].splice(t,1);break}delete this.listeners[e]}}}]),n}(),s=440,r=16384,o=127,u=function(){function n(){e(this,n)}return t(n,null,[{key:"MIDINoteToFrequency",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:s;return t*Math.pow(2,(e-69)/12)}},{key:"PitchWheelToPolar",value:function(e){return-(.5*r-e)}},{key:"PitchWheelToPolarRatio",value:function(e){return n.PitchWheelToPolar(e)/(.5*r)}},{key:"MidiValueToRatio",value:function(e){return e/o}},{key:"MidiValueToPolarRatio",value:function(e){var t=.5*o;return-(t-e)/t}}]),n}(),c=144,l=128,f=160,h=176,k=192,b=208,d=224,v="midimessage",y="NoteOn",g="NoteOff",p="PitchWheel",M="Controller",F="ProgramChange",I="Aftertouch",E="keydown",A="keyup",C=["C","G","D","A","E","B","Cb","F#","Gb","C#","Db","Ab","Eb","Bb","F"],w={C:[0,12,24,36,48,60,72,84,96,108,120],D:[2,14,26,38,50,62,74,86,98,110,122],E:[4,16,28,40,52,64,76,88,100,112,124],F:[5,17,29,41,53,65,77,89,101,113,125],G:[7,19,31,43,55,67,79,91,103,115,127],A:[9,21,33,45,57,69,81,93,105,117],B:[11,23,35,47,59,71,83,95,107,119],"C#":[1,13,25,37,49,61,73,85,97,109,121],"D#":[3,15,27,39,51,63,75,87,99,111,123],"E#":[5,17,29,41,53,65,77,89,101,113,125],"F#":[6,18,30,42,54,66,78,90,102,114,126],"G#":[8,20,32,44,56,68,80,92,104,116],"A#":[10,22,34,46,58,70,82,94,106,118],"B#":[0,12,24,36,48,60,72,84,96,108,120],Db:[1,13,25,37,49,61,73,85,97,109,121],Eb:[3,15,27,39,51,63,75,87,99,111,123],Fb:[4,16,28,40,52,64,76,88,100,112,124],Gb:[6,18,30,42,54,66,78,90,102,114,126],Ab:[8,20,32,44,56,68,80,92,104,116],Bb:[10,22,34,46,58,70,82,94,106,118],Cb:[11,23,35,47,59,71,83,95,107,119]},D={C:["C","D","E","F","G","A","B"],G:["G","A","B","C","D","E","F#"],D:["D","E","F#","G","A","B","C#"],A:["A","B","C#","D","E","F#","G#"],E:["E","F#","G#","A","B","C#","D#"],B:["B","C#","D#","E","F#","G#","A#"],"F#":["F#","G#","A#","B","C#","D#","E#"],"C#":["C#","D#","E#","F#","G#","A#","B#"],Cb:["Cb","Db","Eb","Fb","Gb","Ab","Bb"],Gb:["Gb","Ab","Bb","Cb","Db","Eb","F"],Db:["Db","Eb","F","Gb","Ab","Bb","C"],Ab:["Ab","Bb","C","Db","Eb","F","G"],Eb:["Eb","F","G","Ab","Bb","C","D"],Bb:["Bb","C","D","Eb","F","G","A"],F:["F","G","A","Bb","C","D","E"]},m=function(){function n(){e(this,n)}return t(n,null,[{key:"NoteEvent",value:function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:C[0],i=this.getNoteNames(e.data[1]),s={enharmonics:i,note:n.findNoteInKey(i,a),inKey:n.isNoteInKey(i,a),value:e.data[1],velocity:e.data[2],frequency:u.MIDINoteToFrequency(e.data[1])};return Object.assign(e,s)}},{key:"CCEvent",value:function(e,t){return Object.assign(e,{cc:t||e.data[1],value:e.data[2],ratio:u.MidiValueToRatio(e.data[2]),polarRatio:u.MidiValueToPolarRatio(e.data[2])})}},{key:"MidiControlEvent",value:function(e,t){return Object.assign(e,{cc:t,value:e.data[1],ratio:u.MidiValueToRatio(e.data[2])})}},{key:"PitchWheel",value:function(e){var t=e.data[1]|e.data[2]<<7;return Object.assign(e,{cc:"pitchwheel",value:t,polar:u.PitchWheelToPolar(t),polarRatio:u.PitchWheelToPolarRatio(t)})}},{key:"getNoteNames",value:function(e){var t=[];for(var n in w)w[n].forEach(function(a){e===a&&t.push(n)});return t}},{key:"findNoteInKey",value:function(e,t){for(var a=0;a<e.length;a++){var i=e[a];if(n.matchNoteInKey(i,t))return i}return e[0]}},{key:"isNoteInKey",value:function(e,t){for(var n=0;n<e.length;n++){var a=e[n];if(this.matchNoteInKey(a,t))return!0}return!1}},{key:"matchNoteInKey",value:function(e,t){for(var n=0;n<D[t].length;n++){var a=D[t][n];if(e===a)return!0}return!1}}]),n}(),N=function(){function n(){e(this,n)}return t(n,null,[{key:"NoteOn",value:function(e,t){return new Uint8Array([c,e,t])}},{key:"NoteOff",value:function(e,t){return new Uint8Array([l,e,t])}},{key:"AfterTouch",value:function(e,t){return new Uint8Array([f,e,t])}},{key:"ControlChange",value:function(e,t){return new Uint8Array([h,e,t])}},{key:"ProgramChange",value:function(e){return new Uint8Array([k,e])}},{key:"ChannelPressure",value:function(e){return new Uint8Array([b,e])}},{key:"PitchBend",value:function(e){var t=1,n=1;return new Uint8Array([d,t,n])}},{key:"FakeMessage",value:function(e,t){var a=null;switch(e){case y:a=n.NoteOn(t,127);break;case g:a=n.NoteOff(t,127)}var i=new MIDIMessageEvent(v,{data:a})||{data:a};return m.NoteEvent(i,e,this.key)}}]),n}(),P=function(i){function s(){e(this,s);var t=a(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return t.keysPressed=[],t.keyboadKeyPressed=[],t}return n(s,i),t(s,[{key:"onMIDIMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:C[0],n=null,a=null;switch(e.data[0]){case 128:n=g,delete this.keysPressed[e.data[1]],a=m.NoteEvent(e,n,t);break;case 144:n=e.data[2]>0?y:g,a=m.NoteEvent(e,n,t),n==y?this.keysPressed[e.data[1]]=a:delete this.keysPressed[e.data[1]];break;case 176:n=M,a=m.CCEvent(e);break;case 224:n=p,a=m.PitchWheel(e);break;case 208:n=I,a=m.MidiControlEvent(e,n);break;case 192:n=F,a=m.MidiControlEvent(e,n)}null!==n&&this.executeEventHandlers(n,a)}},{key:"executeEventHandlers",value:function(e,t){if(this.listeners[e])for(var n=this.listeners[e].length-1;n>=0;n--)if(void 0!==this.listeners[e]){if("function"!=typeof this.listeners[e][n]||!this.listeners[e][n])throw"Event handler is not a function.";this.listeners[e][n](t)}}},{key:"onCC",value:function(e,t){var n=function(n){n.cc==e&&t(n)};this.on(M,n)}},{key:"keyToggle",value:function(e,t){this.on(y,e),this.on(g,t)}},{key:"onNoteNumber",value:function(e,t){var n=function(n){n.value==e&&t(n)};this.on(y,n)}},{key:"offNoteNumber",value:function(e,t){var n=function(n){n.value==e&&t(n)};this.on(g,n)}},{key:"keyToggleRange",value:function(e,t,n,a){this.onRange(e,t,n),this.offRange(e,t,a)}},{key:"onSplit",value:function(e,t,n,a){if(t>e)for(var i=e;i<=t;i++)this.onNoteNumber(i,n);else for(var s=t;s>=e;s--)this.onNoteNumber(s,n)}},{key:"offSplit",value:function(e,t,n,a){if(t>e)for(var i=e;i<=t;i++)this.offNoteNumber(i,a);else for(var s=t;s>=e;s--)this.offNoteNumber(s,a)}},{key:"unbindAll",value:function(){this.unBindKeyboard();for(var e in this.listeners)delete this.listeners[e];return!0}},{key:"bindKeyboard",value:function(){var e=this;window.addEventListener(E,function(t){return e.keyboardKeyDown(t)}),window.addEventListener(A,function(t){return e.keyboardKeyUp(t)})}},{key:"unBindKeyboard",value:function(){var e=this;window.removeEventListener(E,function(t){return e.keyboardKeyDown(t)}),window.removeEventListener(A,function(t){return e.keyboardKeyUp(t)})}},{key:"keyboardKeyDown",value:function(e){if(1!=this.keyboadKeyPressed[e.keyCode]){this.keyboadKeyPressed[e.keyCode]=!0;var t=null;switch(e.keyCode){case 90:t=N.FakeMessage(y,60);break;case 83:t=N.FakeMessage(y,61);break;case 88:t=N.FakeMessage(y,62);break;case 68:t=N.FakeMessage(y,63);break;case 67:t=N.FakeMessage(y,64);break;case 86:t=N.FakeMessage(y,65);break;case 71:t=N.FakeMessage(y,66);break;case 66:t=N.FakeMessage(y,67);break;case 72:t=N.FakeMessage(y,68);break;case 78:t=N.FakeMessage(y,69);break;case 74:t=N.FakeMessage(y,70);break;case 77:t=N.FakeMessage(y,71);break;case 188:t=N.FakeMessage(y,72)}null!==t&&this.sendMidiMessage(t)}}},{key:"keyboardKeyUp",value:function(e){if(1==this.keyboadKeyPressed[e.keyCode]){delete this.keyboadKeyPressed[e.keyCode];var t=null;switch(e.keyCode){case 90:t=N.FakeMessage(g,60);break;case 83:t=N.FakeMessage(g,61);break;case 88:t=N.FakeMessage(g,62);break;case 68:t=N.FakeMessage(g,63);break;case 67:t=N.FakeMessage(g,64);break;case 86:t=N.FakeMessage(g,65);break;case 71:t=N.FakeMessage(g,66);break;case 66:t=N.FakeMessage(g,67);break;case 72:t=N.FakeMessage(g,68);break;case 78:t=N.FakeMessage(g,69);break;case 74:t=N.FakeMessage(g,70);break;case 77:t=N.FakeMessage(g,71);break;case 188:t=N.FakeMessage(g,72)}null!==t&&this.sendMidiMessage(t)}}},{key:"sendMidiMessage",value:function(e){}}]),s}(i),O=function(i){function s(){e(this,s);var t=a(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return t.keysPressed=[],t.midiAccess=null,t.loopback=!0,t.boundInputs=[],t.boundOutputs=[],t.key=C[0],window.MIDIMessageEvent||(window.MIDIMessageEvent=function(e,n){return t.name=e,Object.assign(t,n)}),t}return n(s,i),t(s,[{key:"initialize",value:function(){var e=this;if(null===this.midiAccess){if(navigator.requestMIDIAccess)return navigator.requestMIDIAccess({sysex:!1}).then(function(t){return e.onMIDISuccess(t)},function(t){return e.onMIDIFailure(t)});throw"Your browser has no midi support"}}},{key:"setKey",value:function(e){this.key=e}},{key:"getMidiInputs",value:function(){if(null!=this.midiAccess)return this.midiAccess.inputs.values()}},{key:"getMidiOutputs",value:function(){if(null!=this.midiAccess)return this.midiAccess.outputs.values()}},{key:"bindToInput",value:function(e){var t=this;this.boundInputs.push(e),e.onmidimessage=function(e){return t.onMIDIMessage(e,t.key)}}},{key:"unbindInput",value:function(e){var t=this.boundInputs.indexOf(e);this.boundInputs.slice(1,t),e.onmidimessage=null}},{key:"bindToAllInputs",value:function(){if(null!=this.midiAccess)for(var e=this.getMidiInputs(),t=e.next();t&&!t.done;t=e.next())this.bindToInput(t.value)}},{key:"unbindAllInputs",value:function(){this.boundInputs.forEach(this.unbindInput)}},{key:"bindToOutput",value:function(e){this.boundOutputs.push(e)}},{key:"bindToAllOutputs",value:function(){if(null!=this.midiAccess)for(var e=this.getMidiOutputs(),t=e.next();t&&!t.done;t=e.next())this.bindToOutput(t.value)}},{key:"onMIDIFailure",value:function(e){throw e}},{key:"onMIDISuccess",value:function(e){this.midiAccess=e}},{key:"sendMidiMessage",value:function(e){this.boundOutputs.forEach(function(t){t.send(e.data,e.timeStamp)}),this.loopback&&this.onMIDIMessage(e,this.key)}},{key:"keys",get:function(){return C}},{key:"outputDevices",get:function(){for(var e=[],t=this.getMidiOutputs(),n=t.next();n&&!n.done;n=t.next())e.push(n.value);return e}},{key:"inputDevices",get:function(){for(var e=[],t=this.getMidiInputs(),n=t.next();n&&!n.done;n=t.next())e.push(n.value);return e}}]),s}(P);return O}();