var Mizzy=function(){"use strict";var e=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),t=function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)},i=function(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n},r=function(){function t(){e(this,t),this.listeners={}}return n(t,[{key:"on",value:function(e,n){return void 0===this.listeners[e]?this.listeners[e]=[n]:this.listeners[e].push(n),n}},{key:"off",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.listeners[e])if(null==n)for(var t=this.listeners[e].length-1;t>=0;t--)return 1===this.listeners[e].length?(delete this.listeners[e],!0):(this.listeners[e].splice(t,1),!0);else for(var i=0;i<this.listeners[e].length;i++)if(this.listeners[e][i]==n)return this.listeners[e].splice(i,1),0===this.listeners[e].length&&delete this.listeners[e],!0;return!1}},{key:"trigger",value:function(e,n){if(this.listeners[e])for(var t=this.listeners[e].length-1;t>=0;t--)if(void 0!==this.listeners[e]){if("function"!=typeof this.listeners[e][t]||!this.listeners[e][t])throw"Event handler is not a function.";this.listeners[e][t](n)}}}]),t}(),u=440,o=16384,s=127,a=function(){function t(){e(this,t)}return n(t,null,[{key:"MIDINoteToFrequency",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u;return n*Math.pow(2,(e-69)/12)}},{key:"PitchWheelToPolar",value:function(e){return-(.5*o-e)}},{key:"PitchWheelToPolarRatio",value:function(e){return t.PitchWheelToPolar(e)/(.5*o)}},{key:"MidiValueToRatio",value:function(e){return e/s}},{key:"MidiValueToPolarRatio",value:function(e){var n=.5*s;return-(n-e)/n}},{key:"MidiChannel",value:function(e){return(15&e)+1}}]),t}(),l=144,c=128,f=160,h=176,v=192,d=208,y=224,b="midimessage",k="NoteOn",p="NoteOff",g="PitchWheel",C="Controller",E="ProgramChange",I="Aftertouch",M="keydown",m="keyup",N=["C","G","D","A","E","B","Cb","F#","Gb","C#","Db","Ab","Eb","Bb","F"],A={C:[0,12,24,36,48,60,72,84,96,108,120],D:[2,14,26,38,50,62,74,86,98,110,122],E:[4,16,28,40,52,64,76,88,100,112,124],F:[5,17,29,41,53,65,77,89,101,113,125],G:[7,19,31,43,55,67,79,91,103,115,127],A:[9,21,33,45,57,69,81,93,105,117],B:[11,23,35,47,59,71,83,95,107,119],"C#":[1,13,25,37,49,61,73,85,97,109,121],"D#":[3,15,27,39,51,63,75,87,99,111,123],"E#":[5,17,29,41,53,65,77,89,101,113,125],"F#":[6,18,30,42,54,66,78,90,102,114,126],"G#":[8,20,32,44,56,68,80,92,104,116],"A#":[10,22,34,46,58,70,82,94,106,118],"B#":[0,12,24,36,48,60,72,84,96,108,120],Db:[1,13,25,37,49,61,73,85,97,109,121],Eb:[3,15,27,39,51,63,75,87,99,111,123],Fb:[4,16,28,40,52,64,76,88,100,112,124],Gb:[6,18,30,42,54,66,78,90,102,114,126],Ab:[8,20,32,44,56,68,80,92,104,116],Bb:[10,22,34,46,58,70,82,94,106,118],Cb:[11,23,35,47,59,71,83,95,107,119]},w={C:["C","D","E","F","G","A","B"],G:["G","A","B","C","D","E","F#"],D:["D","E","F#","G","A","B","C#"],A:["A","B","C#","D","E","F#","G#"],E:["E","F#","G#","A","B","C#","D#"],B:["B","C#","D#","E","F#","G#","A#"],"F#":["F#","G#","A#","B","C#","D#","E#"],"C#":["C#","D#","E#","F#","G#","A#","B#"],Cb:["Cb","Db","Eb","Fb","Gb","Ab","Bb"],Gb:["Gb","Ab","Bb","Cb","Db","Eb","F"],Db:["Db","Eb","F","Gb","Ab","Bb","C"],Ab:["Ab","Bb","C","Db","Eb","F","G"],Eb:["Eb","F","G","Ab","Bb","C","D"],Bb:["Bb","C","D","Eb","F","G","A"],F:["F","G","A","Bb","C","D","E"]},D=function(){function t(){e(this,t)}return n(t,null,[{key:"NoteEvent",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:N[0],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=e.data[1]+i,u=this.getNoteNames(r),o={enharmonics:u,note:t.findNoteInKey(u,n),inKey:t.isNoteInKey(u,n),value:r,velocity:e.data[2],frequency:a.MIDINoteToFrequency(r),channel:a.MidiChannel(e.data[0])};return Object.assign(e,o)}},{key:"CCEvent",value:function(e,n){return Object.assign(e,{cc:n||e.data[1],value:e.data[2],ratio:a.MidiValueToRatio(e.data[2]),polarRatio:a.MidiValueToPolarRatio(e.data[2]),channel:a.MidiChannel(e.data[0])})}},{key:"MidiControlEvent",value:function(e,n){return Object.assign(e,{cc:n,value:e.data[1],ratio:a.MidiValueToRatio(e.data[2]),channel:a.MidiChannel(e.data[0])})}},{key:"PitchWheelEvent",value:function(e){var n=e.data[1]|e.data[2]<<7;return Object.assign(e,{cc:"pitchwheel",value:n,polar:a.PitchWheelToPolar(n),polarRatio:a.PitchWheelToPolarRatio(n),channel:a.MidiChannel(e.data[0])})}},{key:"getNoteNames",value:function(e){var n=[];for(var t in A)A[t].forEach(function(i){e===i&&n.push(t)});return n}},{key:"findNoteInKey",value:function(e,n){for(var i=0;i<e.length;i++){var r=e[i];if(t.matchNoteInKey(r,n))return r}return e[0]}},{key:"isNoteInKey",value:function(e,n){for(var t=0;t<e.length;t++){var i=e[t];if(this.matchNoteInKey(i,n))return!0}return!1}},{key:"matchNoteInKey",value:function(e,n){for(var t=0;t<w[n].length;t++){var i=w[n][t];if(e===i)return!0}return!1}}]),t}(),P=function(){function t(){e(this,t)}return n(t,null,[{key:"NoteOn",value:function(e,n){return new Uint8Array([l,e,n])}},{key:"NoteOff",value:function(e,n){return new Uint8Array([c,e,n])}},{key:"AfterTouch",value:function(e,n){return new Uint8Array([f,e,n])}},{key:"CC",value:function(e,n){return new Uint8Array([h,e,n])}},{key:"ProgramChange",value:function(e){return new Uint8Array([v,e])}},{key:"ChannelPressure",value:function(e){return new Uint8Array([d,e])}},{key:"PitchBend",value:function(e){var n=0,t=0;return new Uint8Array([y,n,t])}},{key:"NoteEvent",value:function(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:127,r=null;switch(e){case k:r=t.NoteOn(n,i);break;case p:r=t.NoteOff(n,i)}var u=new MIDIMessageEvent(b,{data:r})||{data:r};return D.NoteEvent(u,this.key)}},{key:"CCEvent",value:function(e,n){var i=t.CC(e,n),r=new MIDIMessageEvent(b,{data:i});return D.CCEvent(r)}},{key:"PitchBendEvent",value:function(e){var n=t.PitchBend(e),i=new MIDIMessageEvent(b,{data:n});return D.CCEvent(i)}}]),t}(),O={90:60,83:61,88:62,68:63,67:64,86:65,71:66,66:67,72:68,78:69,74:70,77:71,188:72},T=function(r){function u(){e(this,u);var n=i(this,(u.__proto__||Object.getPrototypeOf(u)).call(this));return n.keysPressed=[],n.keyboardKeyPressed=[],n}return t(u,r),n(u,[{key:"onMIDIMessage",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:N[0],t=null,i=null;switch(240&e.data[0]){case 128:t=p,delete this.keysPressed[e.data[1]],i=D.NoteEvent(e,n);break;case 144:t=e.data[2]>0?k:p,i=D.NoteEvent(e,n),t==k?this.keysPressed[e.data[1]]=i:delete this.keysPressed[e.data[1]];break;case 176:t=C,i=D.CCEvent(e);break;case 224:t=g,i=D.PitchWheelEvent(e);break;case 208:t=I,i=D.MidiControlEvent(e,t);break;case 192:t=E,i=D.MidiControlEvent(e,t)}null!==t&&this.trigger(t,i)}},{key:"onCC",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return null==t?this.on(C,function(t){t.cc==e&&n(t)}):this.on(C,function(i){i.cc==e&&i.channel==t&&n(i)})}},{key:"removeCC",value:function(e){return this.off(C,e)}},{key:"keyToggle",value:function(e,n){return{keyDown:this.on(k,e),keyUp:this.on(p,n)}}},{key:"removeKeyToggle",value:function(e){this.off(k,e.keyDown),this.off(p,e.keyUp)}},{key:"pressNoteNumber",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return null==t?this.on(k,function(t){t.value==e&&n(t)}):this.on(k,function(i){i.value==e&&i.channel==t&&n(i)})}},{key:"removePressNoteNumber",value:function(e){return this.off(k,e)}},{key:"releaseNoteNumber",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return null==t?this.on(p,function(t){t.value==e&&n(t)}):this.on(p,function(i){i.value==e&&i.channel==t&&n(i)})}},{key:"removeReleaseNoteNumber",value:function(e){return this.off(p,e)}},{key:"keyToggleRange",value:function(e,n,t,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return{press:this.onSplit(e,n,t,r),release:this.offSplit(e,n,i,r)}}},{key:"onSplit",value:function(e,n,t){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=[];if(n>e)for(var u=e;u<=n;u++)r.push(this.pressNoteNumber(u,t,i));else for(var o=n;o>=e;o--)r.push(this.pressNoteNumber(o,t,i));return r}},{key:"offSplit",value:function(e,n,t){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=[];if(n>e)for(var u=e;u<=n;u++)r.push(this.releaseNoteNumber(u,t,i));else for(var o=n;o>=e;o--)r.push(this.releaseNoteNumber(o,t,i));return r}},{key:"removeKeyToggleRange",value:function(e){var n=this,t=e.press.forEach(function(e){return n.removePressNoteNumber(e)}),i=e.release.forEach(function(e){return n.removeReleaseNoteNumber(e)});return 1==i&&1==t}},{key:"unbindAll",value:function(){this.unBindKeyboard();for(var e in this.listeners)delete this.listeners[e];return!0}},{key:"bindKeyboard",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;window.addEventListener(M,function(t){return e.keyboardKeyDown(t,n)}),window.addEventListener(m,function(t){return e.keyboardKeyUp(t,n)})}},{key:"unBindKeyboard",value:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;window.removeEventListener(M,function(t){return e.keyboardKeyDown(t,n)}),window.removeEventListener(m,function(t){return e.keyboardKeyUp(t,n)})}},{key:"keyboardKeyDown",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(void 0!=O[e.keyCode]&&1!=this.keyboardKeyPressed[e.keyCode]){this.keyboardKeyPressed[e.keyCode]=!0;var t=P.NoteEvent(k,O[e.keyCode]);null!==t&&this.sendMidiMessage(t,n)}}},{key:"keyboardKeyUp",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(void 0!=O[e.keyCode]&&1==this.keyboardKeyPressed[e.keyCode]){delete this.keyboardKeyPressed[e.keyCode];var t=P.NoteEvent(p,O[e.keyCode]);null!==t&&this.sendMidiMessage(t,n)}}},{key:"sendMidiMessage",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;null!=n&&(e.data[0]=e.data[0]|parseInt(n-1,16)),this.boundOutputs.forEach(function(n){n.send(e.data,e.timeStamp)}),this.loopback&&this.onMIDIMessage(e,this.key)}}]),u}(r),F=function(r){function u(){e(this,u);var n=i(this,(u.__proto__||Object.getPrototypeOf(u)).call(this));return n.keysPressed=[],n.midiAccess=null,n.loopback=!0,n.boundInputs=[],n.boundOutputs=[],n.key=N[0],window.MIDIMessageEvent||(window.MIDIMessageEvent=function(e,t){return n.name=e,Object.assign(n,t)}),n}return t(u,r),n(u,null,[{key:"Generate",get:function(){return P}},{key:"NOTE_ON",get:function(){return k}},{key:"NOTE_OFF",get:function(){return p}},{key:"CONTROLCHANGE",get:function(){return C}},{key:"PITCHWHEEL",get:function(){return g}}]),n(u,[{key:"initialize",value:function(){var e=this;if(null===this.midiAccess)return navigator.requestMIDIAccess?navigator.requestMIDIAccess({sysex:!1}).then(function(n){return e.onMIDISuccess(n)},function(n){return e.onMIDIFailure(n)}):(console.warn("[Mizzy] Your browser does not support Web MIDI API. You can still use the local loopback however."),new Promise(function(e,n){setTimeout(function(){e()},50)}))}},{key:"setKey",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"C";this.key=N[N.indexOf(e.toUpperCase())]||"C"}},{key:"getMidiInputs",value:function(){if(null!=this.midiAccess)return this.midiAccess.inputs.values()}},{key:"getMidiOutputs",value:function(){if(null!=this.midiAccess)return this.midiAccess.outputs.values()}},{key:"bindToInput",value:function(e){var n=this;this.boundInputs.push(e),e.onmidimessage=function(e){return n.onMIDIMessage(e,n.key)}}},{key:"unbindInput",value:function(e){var n=this.boundInputs.indexOf(e);this.boundInputs.slice(1,n),e.onmidimessage=null}},{key:"bindToAllInputs",value:function(){if(null!=this.midiAccess)for(var e=this.getMidiInputs(),n=e.next();n&&!n.done;n=e.next())this.bindToInput(n.value)}},{key:"unbindAllInputs",value:function(){this.boundInputs.forEach(this.unbindInput)}},{key:"bindToOutput",value:function(e){this.boundOutputs.push(e)}},{key:"bindToAllOutputs",value:function(){if(null!=this.midiAccess)for(var e=this.getMidiOutputs(),n=e.next();n&&!n.done;n=e.next())this.bindToOutput(n.value)}},{key:"onMIDIFailure",value:function(e){throw e}},{key:"onMIDISuccess",value:function(e){this.midiAccess=e}},{key:"keys",get:function(){return N}},{key:"outputDevices",get:function(){for(var e=[],n=this.getMidiOutputs(),t=n.next();t&&!t.done;t=n.next())e.push(t.value);return e}},{key:"inputDevices",get:function(){for(var e=[],n=this.getMidiInputs(),t=n.next();t&&!t.done;t=n.next())e.push(t.value);return e}}]),u}(T);return F}();